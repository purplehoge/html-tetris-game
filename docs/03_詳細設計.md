# 詳細設計書 - HTMLテトリス

## クラス・モジュール単位の責務

### 1. GameManager
**責務**: ゲーム全体の状態管理と制御
**メソッド**:
- `init()`: ゲーム初期化
- `start()`: ゲーム開始
- `pause()`: ゲーム一時停止
- `gameLoop()`: メインゲームループ
- `update()`: ゲーム状態更新
- `checkGameOver()`: ゲームオーバー判定

### 2. Tetromino
**責務**: テトロミノの生成、移動、回転制御
**メソッド**:
- `create(type)`: 新テトロミノ生成
- `move(dx, dy)`: 移動処理
- `rotate()`: 回転処理
- `canMove(dx, dy)`: 移動可能性判定
- `canRotate()`: 回転可能性判定

### 3. GameField
**責務**: ゲームフィールドの状態管理
**メソッド**:
- `init()`: フィールド初期化
- `placeTetromino()`: テトロミノ配置
- `checkLines()`: ライン完成チェック
- `clearLines()`: ライン消去処理
- `isCollision()`: 衝突判定

### 4. InputHandler
**責務**: キーボード・タッチ入力処理
**メソッド**:
- `init()`: イベントリスナー設定
- `handleKeyDown(event)`: キー押下処理
- `handleTouchStart(event)`: タッチ開始処理
- `handleTouchMove(event)`: タッチ移動処理

### 5. Renderer
**責務**: Canvas描画処理
**メソッド**:
- `init(canvas)`: Canvas初期化
- `draw()`: 全体描画
- `drawField()`: フィールド描画
- `drawTetromino()`: テトロミノ描画
- `drawUI()`: UI要素描画

## 入出力・例外・前後条件

### GameManager.gameLoop()
- **入力**: なし
- **出力**: なし（副作用：画面更新）
- **例外**: Canvas描画エラー（無視して継続）
- **前条件**: ゲーム初期化済み
- **後条件**: 次フレーム予約済み

### Tetromino.move(dx, dy)
- **入力**: dx(Number), dy(Number) - 移動量
- **出力**: Boolean - 移動成功/失敗
- **例外**: なし
- **前条件**: テトロミノ存在
- **後条件**: 位置更新または変更なし

### GameField.clearLines()
- **入力**: なし
- **出力**: Number - 消去ライン数
- **例外**: なし
- **前条件**: フィールド初期化済み
- **後条件**: 完成ラインが消去済み

## データ構造とアルゴリズム

### ゲームフィールド
```javascript
// 20行×10列の2次元配列
field = Array(20).fill().map(() => Array(10).fill(0));
// 0: 空, 1-7: テトロミノタイプ別色
```

### テトロミノ回転アルゴリズム
```javascript
function rotate(shape) {
  const size = shape.length;
  const rotated = Array(size).fill().map(() => Array(size).fill(0));
  
  for (let i = 0; i < size; i++) {
    for (let j = 0; j < size; j++) {
      rotated[j][size - 1 - i] = shape[i][j];
    }
  }
  return rotated;
}
```

### ライン消去判定
```javascript
function checkLines() {
  const linesToClear = [];
  for (let y = 0; y < 20; y++) {
    if (field[y].every(cell => cell !== 0)) {
      linesToClear.push(y);
    }
  }
  return linesToClear;
}
```

### 衝突判定
```javascript
function isCollision(tetromino, dx = 0, dy = 0) {
  for (let y = 0; y < tetromino.shape.length; y++) {
    for (let x = 0; x < tetromino.shape[y].length; x++) {
      if (tetromino.shape[y][x]) {
        const newX = tetromino.x + x + dx;
        const newY = tetromino.y + y + dy;
        
        // 境界チェック
        if (newX < 0 || newX >= 10 || newY >= 20) return true;
        // フィールド衝突チェック
        if (newY >= 0 && field[newY][newX]) return true;
      }
    }
  }
  return false;
}
```

## 擬似コードとシーケンス図

### メインゲームループ
```
function gameLoop() {
  UPDATE:
    if (落下タイミング) {
      if (テトロミノ.moveDown() == false) {
        フィールド.placeTetromino(現在テトロミノ)
        消去ライン数 = フィールド.clearLines()
        スコア += 計算(消去ライン数, レベル)
        
        if (ゲームオーバー判定()) {
          ゲーム終了()
          return
        }
        
        新テトロミノ = Tetromino.create(ランダムタイプ)
        現在テトロミノ = 新テトロミノ
      }
    }
    
  RENDER:
    Canvas.clear()
    Renderer.drawField()
    Renderer.drawTetromino(現在テトロミノ)
    Renderer.drawUI()
  
  requestAnimationFrame(gameLoop)
}
```

### 入力処理シーケンス
```
User Input → InputHandler → GameManager → Tetromino/GameField → Renderer
```

## HTML構造

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tetris</title>
  <style>/* CSS */</style>
</head>
<body>
  <div class="game-container">
    <canvas id="game-canvas" width="400" height="800"></canvas>
    <div class="game-ui">
      <div class="score">Score: <span id="score">0</span></div>
      <div class="level">Level: <span id="level">1</span></div>
      <div class="lines">Lines: <span id="lines">0</span></div>
      <button id="start-btn">Start Game</button>
      <button id="pause-btn">Pause</button>
    </div>
    <div class="controls">
      <p>Controls:</p>
      <p>← → : Move</p>
      <p>↓ : Soft Drop</p>
      <p>↑ : Rotate</p>
      <p>Space: Hard Drop</p>
    </div>
  </div>
  <script>/* JavaScript */</script>
</body>
</html>
```

## CSS設計

```css
/* レスポンシブ設計 */
@media (max-width: 768px) {
  .game-container { flex-direction: column; }
  #game-canvas { width: 300px; height: 600px; }
}

/* ゲームUI */
.game-container { display: flex; justify-content: center; align-items: center; }
#game-canvas { border: 2px solid #333; background: #000; }
.game-ui { margin-left: 20px; }
.controls { margin-top: 20px; font-size: 14px; }
```

## 設定値・環境依存の扱い

### ゲーム設定定数
```javascript
const GAME_CONFIG = {
  FIELD_WIDTH: 10,
  FIELD_HEIGHT: 20,
  CANVAS_WIDTH: 400,
  CANVAS_HEIGHT: 800,
  BLOCK_SIZE: 20,
  INITIAL_DROP_TIME: 1000, // ms
  LEVEL_UP_LINES: 10,
  SCORE_MULTIPLIER: [0, 40, 100, 300, 1200] // ライン消去数別
};
```

### 色設定
```javascript
const COLORS = {
  I: '#00f0f0', // シアン
  O: '#f0f000', // イエロー
  T: '#a000f0', // パープル
  S: '#00f000', // グリーン
  Z: '#f00000', // レッド
  J: '#0000f0', // ブルー
  L: '#f0a000'  // オレンジ
};
```

## テスト観点

### ユニットテスト
- テトロミノ回転ロジック
- 衝突判定ロジック
- ライン消去ロジック
- スコア計算ロジック

### 結合テスト
- キー入力からテトロミノ動作
- ライン消去からスコア更新
- レベルアップから速度変更

### E2Eテスト
- ゲーム開始から終了まで
- 各ブラウザでの動作確認
- レスポンシブ動作確認
- タッチ操作確認（スマートフォン）

### 境界値テスト
- フィールド端での移動・回転
- 最下段での配置
- 最高スコア・レベル達成
- 連続ライン消去（テトリス）